<style type="text/css">

    label {

        margin-bottom: 10px;
    }
    
    .btn-success {
    	margin-left: 15px;
	}
	
</style>

<h2 class="topic">Assign Employees and Devices to Product Lines</h2>
<div class="detailWrapper">
   <div class="form-row">
      <div class="form-group col-md-6">
         <label>Product Name: </label>
         <input class="form-control" placeholder="Product Name" name="product_name_assign" id="product_name_assign">
      </div>
   </div>
   <div class="clearfix"></div>
   <button id="loadProductionData" onclick="loadProductionData()" class="btn btn-success">Load Production Data</button>
   <br>
   <div class="clearfix"></div>

   <div id="line_div" style="display:none">
      <div class="form-row">
         <div class="form-group col-md-6">
            <label>Select Line: </label>
            <select id="selected_line" name="selected_line" class="form-control">
               <option selected>-- Please Select a Line --</option>
            </select>
         </div>
      </div>
      <br>
      <div class="clearfix"></div>
      
      <table id="datatable" class="display" width="100%"></table>
      
      <!-- start of modal -->
      <div class="modal fade" style="" id="assignDetails" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
         <div class="modal-dialog" style="left:0%">
            <div class="modal-content" style="position: absolute;margin-left: -320px; padding: 10px">
               <div class="modal-header" style="padding:10px; width: 1200px">
                  <button type="button" style="position: relative;left: 115px;" class="close" data-dismiss="modal" aria-label="Close">
                  <span style="position: relative;left: -110px;" aria-hidden="true">&times;</span>
                  </button>
               </div>
               <div class="modal-body" style="padding:1px">
                  <div id="model-details"></div>
               </div>
            </div>
         </div>
      </div>
      <!-- end of modal -->
      
      <div class="clearfix"></div>
      
      <button id="saveAssigneeDetails" onclick="saveAssigneeDetails()" class="btn btn-success">Save Details</button>
   </div>
   <input type="hidden" id="product_name_id" name="product_name_id" value="0">
   <input type="hidden" id="line_count_assign" name="line_count_assign" value="0">
   <input type="hidden" id="product_type_id_assign" name="product_type_id_assign" value="0">
   
</div>
<script>
   var prodArr = [];
   var prodNameArr = [];
   var dataSet = [];
   var detailsArray;
   function loadDataToAssignDetails() {
       $("#model-details").load("pages/assign_details.html");
   }
   
   function loadProductionData() {
       $("#line_div").css({
           "display": "block"
       });
       var count = parseInt($("#line_count_assign").val());
       for (var i = 0; i < count; i++) {
           var val = i + 1;
           $('#selected_line').append($('<option>', {
               value: val,
               text: val
           }));
       }
       loadDataToAssignDetails()
   }
   
   $('#selected_line').on('change', function(e) {
	   if ($("#selected_line option:selected").index() == 0){
		   var table = $('#datatable').DataTable();
		   table.clear().draw();
	   } else{
		   
	   
	   		var table = $('#datatable').DataTable();
	   		table.clear().draw();
	   
	   checkAssigneeDetails();
	   $.ajax({
           url: 'product/list/productname/linedetails',
           dataType: 'json',
           data: {
               product_name: $("#product_name_assign").val()
           },
           type: 'GET',
           success: function(data) {
               setLineDetails(data,detailsArray);
           }
       });
	 }
   });
   function checkAssigneeDetails(){
       $.ajax({
           url: 'product/list/assigneedetail/productid',
           dataType: 'json',
           data: {
               productId: $("#product_name_id").val(),
               selected_line: $("#selected_line").val()
           },
           type: 'GET',
           success: function(assigneeDetailArr) {
        	   console.log(assigneeDetailArr);
        	   detailsArray =  assigneeDetailArr;
           }
       });
   }
   
   function setLineDetails(data,assigneeDetailArr) {
       dataSet = [];
       var loopin = false;
      for (var i = 0; i < data.length; i++) {
      	for (var x = 0; x < assigneeDetailArr.length; x++) {
    	   if(assigneeDetailArr[x].step == data[i].step){   
    		dataSet.push([assigneeDetailArr[x].stepName, assigneeDetailArr[x].step, assigneeDetailArr[x].employeeFullname, assigneeDetailArr[x].deviceCode, assigneeDetailArr[x].sewingSteps, assigneeDetailArr[x].timeTaken, "<a id=\"" + assigneeDetailArr[x].step + "\"onclick=\"loadtoModel(" + assigneeDetailArr[x].step + ")\" data-toggle=\"modal\" data-target=\"#assignDetails\">Assign</a>", assigneeDetailArr[x].employeeId, assigneeDetailArr[x].deviceId, assigneeDetailArr[x].id]);
    		loopin = true;
    		break;
    	   }
    	}
 	   if(!(loopin)){
		   dataSet.push([data[i].stepName, data[i].step, "", "", "", "", "<a id=\"" + data[i].step + "\"onclick=\"loadtoModel(" + data[i].step + ")\" data-toggle=\"modal\" data-target=\"#assignDetails\">Assign</a>", "", "", ""]);
	   }
      }
       var datatable = $("#datatable").DataTable();
       datatable.clear().rows.add(dataSet).draw();
   }
   
   function loadtoModel(id) {
       $(".modal-body #requestedEmployeeName").val("0"); 
       $(".modal-body #requestedDeviceCode").val("0");;
	   for (var i = 0; i < dataSet.length; i++) {
           if (dataSet[i][1] == id) {
               $(".modal-body #step_name").val(dataSet[i][0]);
               $(".modal-body #step").val(dataSet[i][1]);
               $(".modal-body #requestedEmployeeName").val(dataSet[i][2]); 
               $(".modal-body #requestedDeviceCode").val(dataSet[i][3]);
               $(".modal-body #sewing_steps").val(dataSet[i][4]);
               $(".modal-body #time_taken").val(dataSet[i][5]);
               
               if (($(".modal-body #requestedEmployeeName").val() != "") || ($(".modal-body #requestedEmployeeName").val() != "0")) {
            	   for (var k = 0; k < $(".modal-body #employee_name").children('option').length; k++) {
                        if ($(".modal-body #employee_name option").eq(k).text() == $(".modal-body #requestedEmployeeName").val()) {
                                $('.modal-body #employee_name option').eq(k).prop('selected', true);
                                break;
                            }
                        }
                    }
               
               if (($(".modal-body #requestedDeviceCode").val() != "")|| ($(".modal-body #requestedEmployeeName").val() != "0")) {
                   for (var k = 0; k < $(".modal-body #device_code").children('option').length; k++) {
                       if ($(".modal-body #device_code option").eq(k).text() == $(".modal-body #requestedDeviceCode").val()) {
                               $('.modal-body #device_code option').eq(k).prop('selected', true);
                               break;
                           }
                       }
                   }
               break;
           }
       }
   }
   
   function getProductTypes() {
       $.ajax({
           url: 'product/list/producttype',
           dataType: 'json',
           type: 'GET',
           success: function(data) {
               setProductTypes(data);
           }
       });
   }
   $(document).ready(function() {
       $.ajax({
           url: 'product/list/producttype',
           dataType: 'json',
           type: 'GET',
           success: function(data) {
               setProductTypes(data);
           }
       });
   
       $.ajax({
           url: 'product/list/allproductnames',
           dataType: 'json',
           type: 'GET',
           success: function(data) {
               setProductNames(data);
           }
       });
   
       $('#datatable').DataTable({
           data: dataSet,
           columns: [{
                   title: "Step Name"
               },
               {
                   title: "Step"
               },
               {
                   title: "Assigned Employee"
               },
               {
                   title: "Assigned Device"
               },
               {
                   title: "Sewing Steps"
               },
               {
                   title: "Time taken"
               },
               {
                   title: "Assign"
               },
               {
                   title: "Employee Id"
               },
               {
                   title: "Device Id"
               },
               {
                   title: "Assign Details Id"
               }
           ],
           "columnDefs": [{
                   "targets": [7],
                   "visible": false,
                   "searchable": false
               },
               {
                   "targets": [8],
                   "visible": false,
                   "searchable": false
               },
               {
                   "targets": [9],
                   "visible": false,
                   "searchable": false
               }
           ]
       });
   
   });
   
   function setProductNames(prodNames) {
       for (i = 0; i < prodNames.length; i++) {
           var prod = {};
           prod.value = prodNames[i].id;
           prod.label = prodNames[i].productName;
           prod.lineCount = prodNames[i].lineCount
           prodNameArr.push(prod);
       }
       $("#product_type_id_assign").val(prodNames[0].productTypeId);
   }
   
   function setProductTypes(prodTypes) {
       for (i = 0; i < prodTypes.length; i++) {
           var prod = {};
           prod.value = prodTypes[i].id;
           prod.label = prodTypes[i].productType;
           prodArr.push(prod);
           /* $('#product_type').append('<option>' + prodTypes[i].productType + '</option>'); */
       }
   }
   $("#product_type").autocomplete({
       source: prodArr,
       select: function(event, ui) {
           $("#product_type").val(ui.item.label); // display the selected text
           $("#product_type_id").val(ui.item.value); // save selected id to hidden input
           event.preventDefault()
       }
   });
   $("#product_name_assign").autocomplete({
       source: prodNameArr,
       select: function(event, ui) {
           $("#product_name_assign").val(ui.item.label); // display the selected text
           $("#product_name_id").val(ui.item.value); // save selected id to hidden input
           $("#line_count_assign").val(ui.item.lineCount);
           event.preventDefault()
       }
   });
   
   function addToGrid() {
       var json = {
           step: $(".modal-body #step").val(),
           employee_name: $(".modal-body #employee_name option:selected").text(),
           device_code: $(".modal-body #device_code option:selected").text(),
           sewing_steps: $(".modal-body #sewing_steps").val(),
           time_taken: $(".modal-body #time_taken").val(),
           employee_id: $(".modal-body #employee_name").val(),
           device_id: $(".modal-body #device_code").val(),
       }
       for (i = 0; i < dataSet.length; i++) {
           if (dataSet[i][1] == json.step) {
               dataSet[i][2] = json.employee_name;
               dataSet[i][3] = json.device_code;
               dataSet[i][4] = json.sewing_steps;
               dataSet[i][5] = json.time_taken;
               dataSet[i][7] = json.employee_id;
               dataSet[i][8] = json.device_id;
               break;
   
           }
       }
       $('#assignDetails').modal('hide');
       var datatable = $("#datatable").DataTable();
       datatable.clear().rows.add(dataSet).draw();
       resetModel();
   }
   
   function resetModel() {
       $(".modal-body #step").val('');
       /* 		$(".modal-body #employee_name").val(''); */
       $("select #employee_name").attr('selectedIndex', 0);
       /* 		$(".modal-body #device_code").val(''); */
       $("select #device_code").attr('selectedIndex', 0);
       $(".modal-body #sewing_steps").val('');
       $(".modal-body #time_taken").val('');
   }
   
   function saveAssigneeDetails() {
       var jsonArr = [];
       for (i = 0; i < dataSet.length; i++) {
           var json = {
           	product_name: $("#product_name_assign").val(),
           	step_name: dataSet[i][0],
               step: dataSet[i][1],
               employee_name: dataSet[i][2],
               device_code: dataSet[i][3],
               sewing_steps: dataSet[i][4],
               time_taken: dataSet[i][5],
               employee_id: dataSet[i][7],
               device_id: dataSet[i][8],
               id: dataSet[i][9],
               selected_line: $("#selected_line").val()
           };
           jsonArr.push(json);
       }
   		var arrData = JSON.stringify(jsonArr);

   	$.ajax({
           url: 'product/save/assigneedetails',
           dataType: 'json',
           data:{ 
           	jsonArr: arrData
           },
           type: 'POST',
           success: function() {
               alert('sucessfully saved')
           }
       });
   }
   
   function addAssignDetails() {
       $('#assignDetails').modal('hide');
       var id = $(".modal-body #step").val();
       for (var i = 0; i < dataSet.length; i++) {
           if (dataSet[i][1] == id) {
               dataSet[i][2] = $(".modal-body #employee_name").val();
               dataSet[i][3] = $(".modal-body #device_code").val();
               dataSet[i][4] = $(".modal-body #sewing_steps").val();
               dataSet[i][5] = $(".modal-body #time_taken").val();
               dataSet[i][7] = $(".modal-body #employee_id").val();
               dataSet[i][8] = $(".modal-body #device_id").val();
               break;
           }
       }
       var datatable = $("#datatable").DataTable();
       datatable.clear().rows.add(dataSet).draw();
   }
   
   
</script>